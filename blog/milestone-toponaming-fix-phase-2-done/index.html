<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Milestone: Ondsel and FreeCAD team complete phase 2 of the toponaming fix | Ondsel</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ondsel.com/blog/milestone-toponaming-fix-phase-2-done"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Milestone: Ondsel and FreeCAD team complete phase 2 of the toponaming fix | Ondsel"><meta data-rh="true" name="description" content="Back in February, we posted an explanation of the toponaming issue in FreeCAD and a proposal of getting this fixed in the upstream project, with RealThunder’s LinkStage3 fork as a guideline. Since then, we’ve made a lot of progress, but even more work is yet to be done."><meta data-rh="true" property="og:description" content="Back in February, we posted an explanation of the toponaming issue in FreeCAD and a proposal of getting this fixed in the upstream project, with RealThunder’s LinkStage3 fork as a guideline. Since then, we’ve made a lot of progress, but even more work is yet to be done."><meta data-rh="true" property="og:image" content="https://ondsel.com/assets/images/titlecard-9c600c988efb52ccfaac0749f87f4cb3.png"><meta data-rh="true" name="twitter:image" content="https://ondsel.com/assets/images/titlecard-9c600c988efb52ccfaac0749f87f4cb3.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-07-24T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/sliptonic,https://github.com/prokoudine"><meta data-rh="true" property="article:tag" content="freecad,development"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ondsel.com/blog/milestone-toponaming-fix-phase-2-done"><link data-rh="true" rel="alternate" href="https://ondsel.com/blog/milestone-toponaming-fix-phase-2-done" hreflang="en"><link data-rh="true" rel="alternate" href="https://ondsel.com/blog/milestone-toponaming-fix-phase-2-done" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-37JG1KMTYS"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-37JG1KMTYS",{anonymize_ip:!0})</script>


<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ondsel RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ondsel Atom Feed">
<script src="https://boards.greenhouse.io/embed/job_board/js?for=ondsel"></script><link rel="stylesheet" href="/assets/css/styles.1e83884c.css">
<link rel="preload" href="/assets/js/runtime~main.eea602c0.js" as="script">
<link rel="preload" href="/assets/js/main.3ba1e412.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar bg-grid-pattern navbar--fixed-top"><div class="wrapper"><div class="menu_button"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button></div><div class="navbar__inner"><div class="navbar__items navbar_layout"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Ondsel Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Ondsel Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items desktop text_gray"><a class="text_gray navbar__item navbar__link" href="/">Home</a><a class="text_gray navbar__item navbar__link" href="/about">About Us</a><a class="text_gray navbar__item navbar__link" href="/pricing">Pricing</a><a class="text_gray navbar__item navbar__link" href="/contact">Contact</a><a class="text_gray navbar__item navbar__link" href="/careers">Careers</a><a aria-current="page" class="text_gray navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right desktop text_gray"><a href="https://github.com/Ondsel-Development" target="_blank" rel="noopener noreferrer" class="text_gray navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_H2mL"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/milestone-toponaming-fix-phase-2-done">Milestone: Ondsel and FreeCAD team complete phase 2 of the toponaming fix</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/software-bounties-are-a-dumb-idea">Software bounties are a dumb idea</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/build-system-for-custom-data-elements">Let’s Build a Core System for Custom Data Elements in FreeCAD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/freecad-needs-a-better-materials-system">FreeCAD Needs A Better Materials System</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/better-github-issues">What does it mean that my GitHub project has 900 open issues?</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://ondsel.com/assets/images/titlecard-9c600c988efb52ccfaac0749f87f4cb3.png"><header><h1 class="title_f1Hy" itemprop="headline">Milestone: Ondsel and FreeCAD team complete phase 2 of the toponaming fix</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-07-24T00:00:00.000Z" itemprop="datePublished">July 24, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/sliptonic" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/538057?v=4" alt="Brad Collette"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/sliptonic" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Brad Collette</span></a></div><small class="avatar__subtitle" itemprop="description">Ondsel Core Team</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/prokoudine" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/57467?v=4" alt="Alexandre Prokoudine"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/prokoudine" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Alexandre Prokoudine</span></a></div><small class="avatar__subtitle" itemprop="description">Contributing Writer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Back in February, we <a href="https://ondsel.com/blog/freecad-topological-naming/" target="_blank" rel="noopener noreferrer">posted</a> an explanation of the toponaming issue in FreeCAD and a proposal of getting this fixed in the upstream project, with RealThunder’s LinkStage3 fork as a guideline. Since then, we’ve made a lot of progress, but even more work is yet to be done.</p><p>In this post, we’d like to explain how we are separating this work into stages, why FreeCAD 0.21 is not going to be much different from previous releases in terms of toponaming, and what our plan for the next development cycle is.</p><p>While this progress is cause to celebrate, we also caution users to understand that models can (and will) break for reasons besides toponaming even after this project is done.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-this-toponaming-thing-anyway">What’s this toponaming thing anyway?<a href="#whats-this-toponaming-thing-anyway" class="hash-link" aria-label="Direct link to What’s this toponaming thing anyway?" title="Direct link to What’s this toponaming thing anyway?">​</a></h2><p>As models evolve, their geometry changes. Doing a boolean sum of the same object with a different object will create new faces and vertices. So if a feature is attached to an element that no longer exists, the model will break. Topological naming is a way to store all element names in a persistent manner to avoid that scenario. You can read a much more detailed explanation in the <a href="https://ondsel.com/blog/freecad-topological-naming/" target="_blank" rel="noopener noreferrer">previous post</a>. The important thing here is that making topology names persistent implies changing FreeCAD’s source code in many places and the changes are not trivial. This is not a fix you can do on a lazy Sunday afternoon.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-tnp-team">The TNP team<a href="#the-tnp-team" class="hash-link" aria-label="Direct link to The TNP team" title="Direct link to The TNP team">​</a></h2><p>Before we go any further, let&#x27;s introduce the team that has been working on the fix all year so far.</p><p>John Dupuy is an Ondsel employee. He’s project coordinator, does code review, as well as his own share of programming.</p><p>Chris Hennes is FreeCAD maintainer who also writes code and does code review from other contributors. He did a large part of programming in phases 1 and 2 of the TNP fix (more on that below).</p><p>Pesc0 is a new arrival to FreeCAD. When the call for participation at fixing the TNP issue was posted, he picked a few tasks he was interested in, started hacking and — most importantly — didn’t drop the ball. He also turned out to be really great at communication with the team.</p><p>Zheng Lei aka RealThunder (or RT) developed the fix for the toponaming issue in his fork of FreeCAD. His patchset made it possible for the upstream team to study the issue in much more detail, explore possible solutions, and come up with a roadmap. The TNP team uses a lot of his code and the classes he developed. RealThunder was involved in a consulting role and provided some really useful insight.</p><p>Ajinkya Dahale is an active contributor to the project, and employee at Ondsel. His involvement so far is creating the fix for sketch objects.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="staging-the-fix">Staging the fix<a href="#staging-the-fix" class="hash-link" aria-label="Direct link to Staging the fix" title="Direct link to Staging the fix">​</a></h2><p>After studying the issue and the existing fix in RealThunder’s fork, we came up with a plan to introduce topological naming in five phases.</p><p>Phase 1: To begin, we need a way to store and manipulate short references names of elements and names serialized from the element mapping. We also need a way to handle element naming as a whole and store all descriptive elements in one place for easy reference. So this is where we wrote several classes — <code>IndexedName.cpp</code> (save the name of an element), <code>MappedName.cs</code> (store and manipulate the more-complex mapped-name used by elements and the toponaming algorithm), <code>MappedElement.cpp</code> class (save the name parts of an element), <code>ElementMap.h</code> (store all descriptive elements in one place for easy reference).</p><p>Phase 2: The main objective of this phase is to create a way to generatively express the history of an item, create new names and mappings, but not actually rely on them. This phase mainly touches Sketch and Part workbenches.</p><p>This is where we are now. Version 0.21 is coming out soon with stage 1 and stage 2 implemented. Some smaller items remain to be completed.</p><p>Phase 3: This is where we will start applying new names and mappings to geometry elements. We expect that at this point, until optimizations are done, FreeCAD will become somewhat slower. This expected performance regression is one of the main reasons we are not waiting for the entire work to be done to release a new FreeCAD version.</p><p>Phase 4: At this stage, we are planning to start using the new names when recalculating objects in all workbenches.</p><p>Phase 5: This final stage is where we do all the optimization to make FreeCAD fast and snappy while toponaming-safe.</p><p>The plan is to do phases 3 through 5 in the next development cycle leading up to releasing v1.0 some time next year.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="will-toponaming-solve-all-the-problems-with-models-breaking-nope">Will toponaming solve all the problems with models breaking? Nope.<a href="#will-toponaming-solve-all-the-problems-with-models-breaking-nope" class="hash-link" aria-label="Direct link to Will toponaming solve all the problems with models breaking? Nope." title="Direct link to Will toponaming solve all the problems with models breaking? Nope.">​</a></h2><p>There are multiple other opportunities for models to break even when toponaming is not involved. A common reason for that is using relative rather than absolute references when constraining elements of sketches. With relative references, FreeCAD will likely try to solve constraints in a different order, which will change geometry.</p><p>A certain combination of parameters can cause inversion of a part of a sketch. So when you e.g. change a parameter driven via spreadsheet, it will break your model forever, and you won&#x27;t be able to undo and/or recompute.</p><p>FreeCAD also does no validation of user input by itself. It will obediently do whatever the user asks it to do, even if it makes the model explode. This can be worked around by using conditional expressions to normalize user-submitted values that don&#x27;t make sense.</p><p>Brodie Fairhall covered these and a few other cases in a <a href="https://www.youtube.com/watch?v=Yp6cIMA7LsI" target="_blank" rel="noopener noreferrer">video</a> for FreeCAD User Conference 2023. We highly recommend watching it!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-work-on-the-tnp-fix-changed-the-project">How work on the TNP fix changed the project<a href="#how-work-on-the-tnp-fix-changed-the-project" class="hash-link" aria-label="Direct link to How work on the TNP fix changed the project" title="Direct link to How work on the TNP fix changed the project">​</a></h2><p>As a developers community, we’ve already made complex changes to FreeCAD in the past, like switching from Python 2.7 to Python 3, or porting the user interface from Qt 4 to Qt5. But the way we planned that work wasn’t great. Fixing the toponaming issue rivals past challenging projects in virtually every aspect, so it was time to change our approach to planning our work.
To do that, we decided to use GitHub’s projects feature, break the entire project into phases, and, most importantly, avoid trying to complete the entire project within one development cycle.</p><p>Another major change was making unit tests the norm. Until fairly recently, FreeCAD had zero unit tests. It was really bad, because it made discovering and fixing regressions quite a bit of a nightmare. Some work on that had started shortly before our work on TNP began, but we made it the rule that all new code should come with unit tests.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-conclusion">In conclusion<a href="#in-conclusion" class="hash-link" aria-label="Direct link to In conclusion" title="Direct link to In conclusion">​</a></h2><p>Seeing a new contributor pick up rather complex tasks and work on them until the job is done has been one of the most rewarding experiences in this project so far. We would definitely appreciate more people following in the footsteps of Pesc0.</p><p>Here is what you can do. Most of the project conversation is taking place in a <a href="https://t.me/toponamingchat" target="_blank" rel="noopener noreferrer">dedicated Telegram group</a>. The group has be-weekly teleconferences discussing progress and issues. The task list is discussed and built in <a href="https://github.com/FreeCAD/FreeCAD/issues/8432" target="_blank" rel="noopener noreferrer">GitHub issue 8432</a> and new issues are made for each task. You can volunteer for one of those, create a PR, copy in the code from the toponaming branch, then start writing tests to build your understanding of what the code is doing, and iteratively accomplish the task.</p><p>This isn’t the easiest project to accomplish, and as FreeCAD v1.0 release is directly dependent on finalizing the toponaming fix, we encourage all interested developers to join us!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/freecad">freecad</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/development">development</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/software-bounties-are-a-dumb-idea"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Software bounties are a dumb idea</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#whats-this-toponaming-thing-anyway" class="table-of-contents__link toc-highlight">What’s this toponaming thing anyway?</a></li><li><a href="#the-tnp-team" class="table-of-contents__link toc-highlight">The TNP team</a></li><li><a href="#staging-the-fix" class="table-of-contents__link toc-highlight">Staging the fix</a></li><li><a href="#will-toponaming-solve-all-the-problems-with-models-breaking-nope" class="table-of-contents__link toc-highlight">Will toponaming solve all the problems with models breaking? Nope.</a></li><li><a href="#how-work-on-the-tnp-fix-changed-the-project" class="table-of-contents__link toc-highlight">How work on the TNP fix changed the project</a></li><li><a href="#in-conclusion" class="table-of-contents__link toc-highlight">In conclusion</a></li></ul></div></div></div></div></div><footer class="footer bg-transparent footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col flex footer-layout"><div><div class="footer__title">Contact Us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/ondsel" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:contact@ondsel.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">contact@ondsel.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/ondsel" target="_blank" rel="noopener noreferrer" class="footer__link-item">facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="col footer__col flex footer-layout"><div><div class="footer__title">FreeCAD</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://freecad.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/FreeCAD" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div><div class="footer__bottom copy_right text--center"><div class="footer__copyright">Copyright © 2023 Ondsel, Inc. </div></div></div></footer></div>
<script src="/assets/js/runtime~main.eea602c0.js"></script>
<script src="/assets/js/main.3ba1e412.js"></script>
</body>
</html>